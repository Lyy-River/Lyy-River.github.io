---
layout: post
title: "DTF 构建 SEEG 脑网络：从 MVAR 到频域因果关系"
date: 2025-10-28
categories: [BrainNetwork]
tags: [DTF, MVAR, SEEG, Connectivity, Python, SignalProcessing]
lang: zh
math: true
author: "Yangyi Luo"
---


详细讲解构建 **SEEG 脑网络** 的经典范式，重点介绍了 **方向性传递函数（DTF, Directed Transfer Function）** 的数学原理与计算步骤。  <!--more-->
所有代码与示例数据已上传至 [GitHub 项目仓库 🔗](https://github.com/Lyy-River/SEEG_project)。  

# 方法综述：构建 SEEG 脑网络的经典范式

【方法：构建SEEG脑网络的经典范式】Peng-SEEG-based epileptic seizure network modeling and analysis for pre-surgery evaluation-2023-Computers in Biology and Medicine


# 基础知识

## 一、LDA 在本文中的应用

- SEEG 中存在数百个电极接触点，需选出与发作最相关的节点。
- 作者用 **LDA 评分排序**，选出前 20 个接触点作为网络节点。

> 文中原话：“LDA is applied to firstly rank the SEEG contact points and then select discriminative ones with the highest LDA values.”

这些节点在临床中也得到了验证，说明其解释力较强。

### LDA 的数学原理（简要）

目标：在二分类（发作 vs 非发作）中，寻找能最大区分类别的投影方向。

#### 1. 输入结构：

- $N$ 个样本，$d$ 维特征
- 两类标签：Ictal（发作）与 Non-ictal（非发作）

#### 2. 计算类内散度 $S_W$ 与类间散度 $S_B$

$$
S_W = \sum_{i=1}^{2} \sum_{x \in \mathcal{D}_i} (x - \mu_i)(x - \mu_i)^T
$$

$$
S_B = \sum_{i=1}^{2} n_i (\mu_i - \mu)(\mu_i - \mu)^T
$$

#### 3. 解广义特征值问题：

$$
S_W^{-1} S_B w = \lambda w
$$

最大特征值对应的 $w$ 为最优投影方向。

#### 4. 接触点的 LDA 得分

每个接触点作为一个特征维度，其得分表示其区分能力。

---

#### **3.1. 多变量自回归模型（MVAR）建模**

设 $ X(t) \in \mathbb{R}^N $ 表示 N 个通道的SEEG信号，使用MVAR模型描述其动态关系：

$$X(t) = \sum_{k=1}^{p} A_k X(t-k) + E(t)$$

其中：

- $A_k \in \mathbb{R}^{N \times N}$ ：第 $k$ 阶的系数矩阵；
- $E(t)$ ：残差白噪声向量；
- $p$ ：模型阶数。

#### **3.2. 动态传递函数（DTF）**

将MVAR模型变换到频域，得传递函数 H(f)：**<u>考虑单位根问题，如何检验</u>**

**<u>为什么A-1 = Hf的转移概率</u>**

$$
H(f) = \left( I - \sum_{k=1}^{p} A_k e^{-j 2\pi f k} \right)^{-1}
$$

传统 DTF 定义为：

$$
DTF_{ij}(f) = \frac{|H_{ij}(f)|^2}{\sum_{k=1}^{N} |H_{ik}(f)|^2}
$$

**问题：** DTF考虑的是“输出信号的总贡献”，对共线性和冗余路径不敏感。


## 二、DTF 的基本原理与实现流程

DTF（Directed Transfer Function）是基于 MVAR 的频域因果分析方法，是 Granger 因果的频域扩展。

### 实现流程概述：

#### 1. 节点选择（Node Selection）

- 使用 LDA 筛选相关 SEEG 电极点
- 本项目中拟替换为“致痫指数 EI”作为筛选指标

#### 2. 构建 MVAR 模型：

$$
\mathbf{x}(n) = \sum_{k=1}^{K} \mathbf{A}(k)\mathbf{x}(n-k) + \mathbf{e}(n)
$$

- $\mathbf{x}(n)$：$C \times 1$ 向量（C 通道信号）
- $\mathbf{A}(k)$：$C \times C$ 的滞后系数矩阵
- $K$ ：滞后阶数
- $\mathbf{e}(n)$ ：白噪声

#### 3. 频域变换与 DTF 计算：

对 MVAR 进行傅里叶变换得：

$$
\mathbf{X}(f) = \mathbf{H}(f)\mathbf{E}(f), \quad \mathbf{H}(f) = \mathbf{A}^{-1}(f)
$$

每个 $H_{ij}(f)$ 表示频率 $f$ 上，通道 $j$ 对通道 $i$ 的因果影响强度。

#### 推导回顾：

- 利用时移性质 $x(n-k) \xrightarrow{\mathcal{F}} e^{-j2\pi fk}X(f)$
- 定义：

$$
\mathbf{A}(f) = \mathbf{I} - \sum_{k=1}^{K} \mathbf{A}(k) e^{-j2\pi fk}
$$

- 所以：

$$
\mathbf{H}(f) = \mathbf{A}^{-1}(f)
$$

#### 各矩阵解释：

| 矩阵 | 含义 | 解释方式 |
|------|------|----------|
| $A(k)$ | 滞后系数矩阵 | 时域上某通道滞后对另一通道的线性影响 |
| $A(f)$ | 频域滤波系数 | 频率 $f$ 上的调制作用 |
| $H(f)$ | 频域传递函数 | 通道间频域上的方向性影响强度 |

#### 4. 归一化并构造 DTF 矩阵

- 将 $H_{ij}(f)$ 归一化，用以表示频段（比如β波段 13–30 Hz）上的方向性信息流强度。



**1.归一化 DTF（每个频点）**

对每一个频率 $f$，定义：
$$
 \psi_{ij}(f) = \frac{|H_{ij}(f)|^2}{\sum_{j=1}^{C}|H_{ij}(f)|^2} 
$$


其中：

 
- 分子表示从 j → i 的“信号传输能量”
 
- 分母是 i 通道从所有其他通道接收到的能量总和（归一化）
 
- $\psi_{ij}(f)$ 表示“在频率 $f$ 上，通道 $j$ 对通道 $i$ 的相对影响力（归一化）”




**2.在频带 [$f_1, f_2$] 内积分（求频带 DTF）**

我们对上面的频点归一化值在整个频带上做求和（数值积分）：

$$
 \phi_{ij}(f_1, f_2) = \sum_{f = f_1}^{f_2} \psi_{ij}(f) 
$$

假设频率被均匀离散化为 $$N$$ 点（如 1000 Hz 采样，对应 512 点 FFT），那你就选出对应频带的频点索引做累加。

例如对 β 波段（13–30Hz），你可以做：



```python
phi_ij = np.sum(psi_ij[freq_indices_13_to_30])
```





#### **补充说明** 

 
- 得到完整的 DTF 矩阵 $\phi_{ij}$ 后，你会得到一个 $C \times C$ 的矩阵，其中每个元素表示信号 j 对信号 i 在 β 波段内的方向性影响。
 
- 再进行**稀疏化** （如只保留 top 25%），可用于构建有向功能连接网络。
 
- 可进一步求每个节点的 **outflux（输出强度）**  和 **influx（输入强度）** ：

$$
 \text{outflux}_c = \sum_{i \ne c} \phi_{ic}, \quad
\text{influx}_c = \sum_{j \ne c} \phi_{cj} 
$$




---


##  三、MVAR 模型的作用 


MVAR 在 DTF 中的作用至关重要：

| 作用 | 说明 | 
| --- | --- | 
| 建模信号的动态依赖关系 | 捕捉当前值如何受过去多个变量的线性影响，保留时序特性。 | 
| 频域因果关系推导基础 | 傅里叶变换后的 MVAR 系数矩阵$ \mathbf{A}(f)$ 是 DTF 的核心组成。 | 
| 支持方向性推断 | 由于 $\mathbf{H}(f)$ 非对称，因此可识别 $A→B ≠ B→A$ 的情况。 | 
| 多通道建模能力 | 能同时建模所有节点间的相互关系，避免遗漏潜在通路。 | 





##  四、为什么DTF能反映因果性？ 

这是基于**Granger因果性** 在频域上的扩展：


> 如果信号 X 的过去值能显著提高对信号 Y 的当前值的预测能力，那么我们说 X “Granger 因果地影响” Y。

DTF 采用的 MVAR 模型本质上就是在检验“信号 j 的历史是否对信号 i 的当前值有预测能力”，只不过它是在频域上体现为某个频率段的传递强度 $H_{ij}(f)$，再通过归一化和稀疏化提取重要的方向性影响路径。


---




# 实例解析——构造DTF 


假设我们有 4 个通道（神经电极）：

 
 $$x_1(n), x_2(n), x_3(n), x_4(n)$$


使用 MVAR 模型：

$$
 \mathbf{x}(n) = \sum_{k=1}^{3} \mathbf{A}(k)\mathbf{x}(n-k) + \mathbf{e}(n) 
$$






 构造三个自回归系数矩阵$（A(1), A(2), A(3)） $



🔹 **A(1)：第1个滞后项（最近的影响）**

$$
 \mathbf{A}(1) = \begin{bmatrix}
0.2 & 0.3 & 0   & 0 \\
0   & 0.1 & 0.4 & 0 \\
0   & 0   & 0.3 & 0.2 \\
0.1 & 0   & 0   & 0.4 \\
\end{bmatrix} 
$$


解释示例：

 
- $A_{12}(1) = 0.3$：表示通道2在上一时刻对通道1当前值有 **0.3 的正向影响**
 
- $A_{34}(1) = 0.2$：通道4 在上一时刻影响通道3
 
- 对角线表示每个通道自己的“惯性”（自回归）




🔹 **A(2)：第2个滞后项**

$$
 \mathbf{A}(2) = \begin{bmatrix}
0 & 0 & 0.1 & 0 \\
0 & 0 & 0 & 0 \\
0.2 & 0 & 0 & 0 \\
0 & 0.1 & 0 & 0 \\
\end{bmatrix} 
$$


解释：

 
- $A_{13}(2) = 0.1$：通道3在两步前对通道1有微弱影响
 
- $A_{31}(2) = 0.2$：通道1在两步前影响通道3






🔹 **A(3)：第3个滞后项** 

$$
 \mathbf{A}(3) = \begin{bmatrix}
0 & 0 & 0 & 0 \\
0.1 & 0 & 0 & 0 \\
0 & 0.1 & 0 & 0 \\
0 & 0 & 0 & 0 \\
\end{bmatrix} 
$$


解释：

 
- $A_{21}(3) = 0.1$：通道1在 3 步前对通道2有影响
 
- $A_{32}(3) = 0.1$：通道2 在 3 步前影响通道3







最终系统的表达式为：

$$
 \mathbf{x}(n) = \mathbf{A}(1)\mathbf{x}(n-1) + \mathbf{A}(2)\mathbf{x}(n-2) + \mathbf{A}(3)\mathbf{x}(n-3) + \mathbf{e}(n) 
$$

即每一个通道的当前值 $x_i(n)$ 是其它通道在 $n-1$、$n-2$、$n-3$ 时刻的线性组合。

$$
 x_3(n) = 0.3 x_3(n-1) + 0.2 x_4(n-1) + 0.2 x_1(n-2) + 0.1 x_2(n-3) + e_3(n) 
$$



 
表示通道3是个“混合型”节点，受其它多个通道在不同滞后的输入影响。
 
系数表示的是每条路径的线性权重，体现了**功能连接的方向性和强度** 。







### 数学推导过程总结 


我们从 MVAR 模型出发：

$$
 \mathbf{x}(n) = \sum_{k=1}^3 \mathbf{A}(k)\mathbf{x}(n-k) + \mathbf{e}(n) 
$$


进行傅里叶变换，得：

$$
 \mathbf{A}(f) = \mathbf{I} - \sum_{k=1}^3 \mathbf{A}(k) e^{-j 2\pi f k / f_s} 
$$

$$
 \mathbf{H}(f) = \mathbf{A}^{-1}(f) 
$$


归一化 DTF 为：

$$
 \psi_{ij}(f) = \frac{|H_{ij}(f)|^2}{\sum_{j=1}^{C}|H_{ij}(f)|^2} 
$$


最后在 β 波段（13–30 Hz）内进行平均：

$$
 \phi_{ij}^{(\beta)} = \frac{1}{N_{\beta}} \sum_{f \in \beta \text{ band}} \psi_{ij}(f) 
$$






以下是根据设定参数（$C = 4$ , $K = 3$）计算得到的 **β 波段（13–30 Hz）内的 DTF 频带平均矩阵** （已归一化）：

$$
 \text{DTF}_{\beta} =
\begin{bmatrix}
0.866 & 0.085 & 0.047 & 0.002 \\
0.031 & 0.819 & 0.143 & 0.006 \\
0.047 & 0.032 & 0.883 & 0.038 \\
0.012 & 0.018 & 0.004 & 0.966 \\
\end{bmatrix} 
$$






示例解释 

 
- $\psi_{11} = 0.866$：说明通道1主要自反馈（86.6%）
 
- $\psi_{13} = 0.047$：通道3以4.7%的强度影响通道1
 
- $\psi_{23} = 0.143$：通道3较强地影响通道2（14.3%）

这说明 **信号之间的信息流是方向性的** ，可以用这个矩阵构建 DTF 网络，找出“驱动源头”或“影响目标”。


---





### 什么是频域系数矩阵 $A(f)$？
在多变量自回归模型（MVAR）中，我们从时域模型出发：

$$
 \mathbf{x}(n) = \sum_{k=1}^K \mathbf{A}(k)\mathbf{x}(n-k) + \mathbf{e}(n) 
$$


对其进行傅里叶变换，得到了频域关系：

$$
 \mathbf{A}(f)\mathbf{X}(f) = \mathbf{E}(f) 
$$


其中：

$$
 \mathbf{A}(f) = \mathbf{I} - \sum_{k=1}^{K} \mathbf{A}(k) e^{-j2\pi f k / f_s} 
$$






####  A(f) 的含义 

 
- **本质** ：$A(f)$ 是频域下的“残差抑制矩阵”，也可以理解为一个“滤波器核”。
 
- 它**描述了系统对不同频率信号的响应（或衰减程度）** ，但是从“残差”的角度来描述的。
 
- 每个元素 $A_{ij}(f)$ 表示：**每个元素 $A_{ij}(f)$ 表示：频率为 $f$ 时，通道 $j$ 对通道 $i$ 的“逆贡献”或“抵消程度”**









**举个例子说明**

假设 $A(f)$ 某一频率下：

$$
 \mathbf{A}(f_0) =
\begin{bmatrix}
1 & -0.3 & 0 & 0 \\
0 & 1 & -0.4 & 0 \\
0 & 0 & 1 & -0.2 \\
-0.1 & 0 & 0 & 1 \\
\end{bmatrix} 
$$


这意味着：

 
- 在频率 $f_0$ 下，通道2的影响将通过 $-0.3$ 抑制通道1。
 
- 通道3 会以 $-0.4$ 的系数贡献于通道2，最终影响建模为残差 $\mathbf{e}(f)$。

而对应的 $\mathbf{H}(f_0) = A^{-1}(f_0)$ 就反映了这些影响**综合作用后，信号之间最终的频域传输通路** 。




**小结**

| 矩阵 | 本质含义 | 
| --- | --- | 
| A(f) | 频率依赖性滤波器核（频域预测器），描述各频率下的残差信号组合规则 | 
| H(f) | 系统的频域传递函数，是直接用于 DTF 分析的主角，反映信号之间在各频率的“有效连接（因果传导）” | 


